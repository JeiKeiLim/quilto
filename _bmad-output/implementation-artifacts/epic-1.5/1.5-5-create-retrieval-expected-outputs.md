# Story 1.5-5: Create Retrieval Expected Outputs

Status: done

## Story

As a **Quilto developer**,
I want **expected outputs for Retriever agent testing**,
So that **retrieval accuracy can be validated (Epic 3 preparation)**.

## Acceptance Criteria

1. **Test cases stored in correct location** - All retrieval test cases are created in `tests/corpus/fitness/expected/retrieval/` directory

2. **Test case structure defined** - Each test case is a JSON file with `query`, `strategy`, `expected_entry_ids` fields as specified in epics.md

3. **Date-based retrieval covered** - Test cases include queries requiring date range filtering (e.g., "workouts last week", "January 2019 sessions")

4. **Keyword-based retrieval covered** - Test cases include queries requiring exercise/keyword matching (e.g., "bench press workouts", "deadlift sessions")

5. **Pattern matching covered** - Test cases include queries requiring pattern recognition (e.g., "heavy days", "push exercises")

6. **Test cases use existing entries** - All `expected_entry_ids` reference actual dates from `from_csv/` and `synthetic/` entries

7. **At least 15 retrieval test cases created** - Minimum count per epics.md requirements

8. **Validation test created** - pytest test validates JSON structure and that referenced entry IDs exist

## Tasks / Subtasks

- [x] Task 1: Create directory structure and schema (AC: #1, #2)
  - [x] 1.1 Create `tests/corpus/fitness/expected/retrieval/` directory
  - [x] 1.2 Create Pydantic schema `retrieval_test_case.py` in `tests/corpus/schemas/`
  - [x] 1.3 Export schema from `__init__.py`

- [x] Task 2: Create date-based retrieval test cases (AC: #3, #6)
  - [x] 2.1 Create test case: "workouts in January 2019" (expect 2019-01-28, 2019-01-29, 2019-01-31)
  - [x] 2.2 Create test case: "workouts in February 2019" (expect all Feb 2019 entries)
  - [x] 2.3 Create test case: "workouts from first week of March 2019" (expect 2019-03-04, 2019-03-05, 2019-03-08)
  - [x] 2.4 Create test case: "September 2019 sessions" (expect all Sep 2019 entries)
  - [x] 2.5 Create test case: "workouts between 2019-02-01 and 2019-02-15"

- [x] Task 3: Create keyword-based retrieval test cases (AC: #4, #6)
  - [x] 3.1 Create test case: "deadlift workouts" (expect entries with deadlift: sumo, trap bar, conventional)
  - [x] 3.2 Create test case: "push press sessions" (expect entries containing push press)
  - [x] 3.3 Create test case: "bench press workouts" (expect entries with bench variations)
  - [x] 3.4 Create test case: "squat sessions" (expect entries with squat exercises)
  - [x] 3.5 Create test case: "overhead press workouts" (expect OHP and push press entries)

- [x] Task 4: Create pattern matching retrieval test cases (AC: #5, #6)
  - [x] 4.1 Create test case: "heavy deadlift days" (expect entries with weight >= 180kg, e.g., 2019-01-28 has 190kg)
  - [x] 4.2 Create test case: "high volume workouts" (expect entries with >= 20 total reps per exercise)
  - [x] 4.3 Create test case: "workouts mentioning shoulder issues" (expect entries with shoulder-related notes, e.g., 어깨)
  - [x] 4.4 Create test case: "Korean language entries" (identify Korean-only entries from from_csv/)
  - [x] 4.5 Create test case: "workouts with warm-up sets mentioned" (expect entries with 웜업 or warmup)

- [x] Task 5: Validate test cases (AC: #7, #8)
  - [x] 5.1 Create pytest test `tests/corpus/test_retrieval_expected.py`
  - [x] 5.2 Validate all JSON files parse correctly against schema
  - [x] 5.3 Validate all `expected_entry_ids` reference existing entries
  - [x] 5.4 Verify minimum 15 test cases exist
  - [x] 5.5 Run `uv run pyright` and `uv run ruff check .`

## Dev Notes

### Schema Design

Based on the epics.md specification, create this schema:

```python
# tests/corpus/schemas/retrieval_test_case.py
from pydantic import BaseModel, ConfigDict


class RetrievalStrategy(BaseModel):
    """Strategy for retrieving entries.

    Attributes:
        type: Strategy type (date_range, keyword, pattern).
        start: Start date for date_range type (YYYY-MM-DD).
        end: End date for date_range type (YYYY-MM-DD).
        keywords: List of keywords/exercise names to match.
        pattern: Description of pattern to identify.
    """

    model_config = ConfigDict(strict=True)

    type: str  # "date_range" | "keyword" | "pattern"
    start: str | None = None
    end: str | None = None
    keywords: list[str] = []
    pattern: str | None = None


class RetrievalTestCase(BaseModel):
    """Expected output for Retriever agent testing.

    Attributes:
        query: Natural language query from user.
        strategy: Retrieval strategy defining how to find entries.
        expected_entry_ids: List of entry IDs (dates/filenames) that should be returned.
    """

    model_config = ConfigDict(strict=True)

    query: str
    strategy: RetrievalStrategy
    expected_entry_ids: list[str]
```

### Available Fitness Entries

The test corpus contains **93 from_csv entries** from these date ranges:

**2019 entries (73 total - primary testing data):**
- January: 2019-01-28, 2019-01-29, 2019-01-31 (3)
- February: 2019-02-01, 2019-02-04, 2019-02-05, 2019-02-08, 2019-02-11, 2019-02-12, 2019-02-18, 2019-02-19, 2019-02-25, 2019-02-26, 2019-02-27, 2019-02-28 (12)
- March: 2019-03-04, 2019-03-05, 2019-03-08, 2019-03-11, 2019-03-12, 2019-03-13, 2019-03-15, 2019-03-18, 2019-03-19, 2019-03-25, 2019-03-26, 2019-03-29 (12)
- April: 2019-04-01, 2019-04-03, 2019-04-09, 2019-04-10, 2019-04-17, 2019-04-22, 2019-04-23, 2019-04-29 (8)
- May: 2019-05-05, 2019-05-15, 2019-05-16, 2019-05-20, 2019-05-27, 2019-05-29 (6)
- July: 2019-07-26, 2019-07-29, 2019-07-31 (3)
- August: 2019-08-05, 2019-08-07, 2019-08-12, 2019-08-30 (4)
- September: 2019-09-02, 2019-09-03, 2019-09-05, 2019-09-06, 2019-09-09, 2019-09-10, 2019-09-16, 2019-09-17, 2019-09-18, 2019-09-19, 2019-09-21, 2019-09-23, 2019-09-24, 2019-09-26, 2019-09-27, 2019-09-30 (16)
- October: 2019-10-14, 2019-10-15, 2019-10-17, 2019-10-21, 2019-10-22, 2019-10-30 (6)
- November: 2019-11-07, 2019-11-12 (2)

**2021-2024 entries (20 total):**
- 2021: 2021-02-25, 2021-02-28 (2)
- 2022: 2022-02-07, 2022-02-08, 2022-02-10, 2022-03-17, 2022-03-24, 2022-03-27, 2022-04-15, 2022-05-13, 2022-05-24, 2022-05-27, 2022-06-02, 2022-06-14, 2022-07-02 (13)
- 2023: 2023-03-20, 2023-08-26, 2023-08-30, 2023-08-31 (4)
- 2024: 2024-02-13, 2024-03-10 (2)

**Synthetic entries (50 total, in `synthetic/` folder):**
- typo-001..010 (10 entries with intentional typos)
- minimal-001..010 (10 minimal/terse entries)
- verbose-001..010 (10 verbose/detailed entries)
- multilingual-001..010 (10 Korean-English mixed entries)
- multi_domain-001..010 (10 multi-domain entries)

### Exercise Types in Corpus

From parsed JSON files, exercises found in the corpus include:
- **Deadlift variants:** Trap Bar Deadlift, Sumo Deadlift (Barbell), Conventional Deadlift
- **Press variants:** Push Press, Overhead Press (Barbell), Incline Bench Press (Barbell), Arnold Press (Dumbbell)
- **Row variants:** T Bar Row
- **Other compound movements:** Squats, accessory exercises

**Weight ranges in corpus:**
- Trap Bar Deadlift: up to 190kg (2019-01-28)
- Sumo Deadlift: up to 140kg (2019-09-02)
- Overhead Press: typically 40-50kg range
- Incline Bench Press: up to 80kg (2019-02-01)

### Korean Language Notes

Many entries are in Korean. Common Korean fitness terms found in corpus:
- 트랩바 = Trap bar
- 데드리프트 = Deadlift
- 푸쉬프레스 = Push press
- 스모 = Sumo
- 아놀드프레스 = Arnold Press
- 인클라인 = Incline
- 티바로우 = T Bar Row
- 키로 = kg
- 세트 = sets
- 렙/개 = reps
- 웜업 = warmup
- 어깨 = shoulder
- 무거웠음 = was heavy
- 올렸다가/내려옴 = increased then decreased (weight)
- 드랍 = drop (drop set)

### Test Case JSON Format

Follow this format for each test case:

```json
{
  "query": "deadlift workouts in late January 2019",
  "strategy": {
    "type": "date_range",
    "start": "2019-01-21",
    "end": "2019-01-31",
    "keywords": ["deadlift", "데드리프트"]
  },
  "expected_entry_ids": ["2019-01-28"]
}
```

**Note:** Only reference dates that exist in the corpus (see "Available Fitness Entries" above).

### File Naming Convention

Name files descriptively:
- `date-range-jan-2019.json`
- `keyword-deadlift.json`
- `pattern-heavy-days.json`

### Project Structure Notes

- This is **Quilto framework** test infrastructure (domain-agnostic retrieval testing)
- These test cases prepare for **Epic 3: Query & Retrieval** (Story 3.3: Implement Retriever Agent)
- Retrieval expected outputs are for **fitness domain only** (unlike multi-domain parser outputs)
- Location: `tests/corpus/fitness/expected/retrieval/` (per directory structure in epics.md)

### Validation Test Requirements

The pytest validation test (`tests/corpus/test_retrieval_expected.py`) must:
1. Load all JSON files from `tests/corpus/fitness/expected/retrieval/`
2. Validate each JSON parses against `RetrievalTestCase` schema
3. Check that every `expected_entry_id` references an existing entry in:
   - `tests/corpus/fitness/entries/from_csv/{date}.md` OR
   - `tests/corpus/fitness/entries/synthetic/{id}.md`
4. Count total test cases and assert >= 15
5. Report clear error messages for missing entries or schema violations

### Validation Command

After creating outputs:
```bash
uv run ruff check . && uv run pyright && uv run pytest tests/corpus/test_retrieval_expected.py -v
```

### Schema Integration

After creating `retrieval_test_case.py`, add to `tests/corpus/schemas/__init__.py`:
```python
from tests.corpus.schemas.retrieval_test_case import RetrievalStrategy, RetrievalTestCase

__all__ = [
    # ... existing exports ...
    "RetrievalStrategy",
    "RetrievalTestCase",
]
```

### References

- [Source: _bmad-output/planning-artifacts/epics.md#Story 1.5-5] - Full acceptance criteria and JSON format example
- [Source: tests/corpus/schemas/expected_output.py] - Existing schema patterns (ConfigDict, Google docstrings)
- [Source: tests/corpus/schemas/__init__.py] - Export pattern for new schemas
- [Source: tests/corpus/fitness/entries/from_csv/] - Available entry dates for expected_entry_ids (93 entries)
- [Source: tests/corpus/fitness/expected/parser/*.json] - Parsed exercise data to understand what exercises exist
- [Source: _bmad-output/implementation-artifacts/epic-1.5/1.5-4-create-multi-domain-expected-parser-outputs.md] - Previous story patterns for schema creation

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A

### Completion Notes List

- Created `RetrievalStrategy` and `RetrievalTestCase` Pydantic schemas following existing patterns (ConfigDict strict mode, Google-style docstrings)
- Created 15 retrieval test cases covering all required categories:
  - **Date-based (5):** Jan 2019, Feb 2019, first week March 2019, Sep 2019, early Feb 2019
  - **Keyword-based (5):** deadlift, push press, bench press, squat, overhead press
  - **Pattern-based (5):** heavy deadlift, high volume, shoulder issues, Korean entries, warmup sets
- All `expected_entry_ids` validated against actual entries in corpus (93 from_csv + 50 synthetic)
- Validation test (`test_retrieval_expected.py`) includes 17 test cases covering schema validation, entry existence, and coverage requirements
- All tests pass: `uv run pytest` (244 passed), `uv run pyright` (0 errors), `uv run ruff check .` (clean)

### Code Review Fixes (2026-01-09)

- **H1 Fixed:** Added `Literal` type constraint (`StrategyType`) for `RetrievalStrategy.type` field to enforce valid values at schema level
- **M1 Fixed:** Updated `__init__.py` docstring to reflect broader scope (parser + retrieval schemas)
- **M2 Fixed:** Corrected 2024 entry count from "(1)" to "(2)" in Dev Notes
- **M3 Fixed:** Added `TestRetrievalTestCaseRobustness` class with 2 tests for schema edge case handling
- **L3 Fixed:** Updated schema docstring to reference specific story (3-3: Implement Retriever Agent)
- Exported `StrategyType` from `__init__.py` for external use
- Test count increased from 17 to 19 tests

### File List

**New files:**
- `tests/corpus/schemas/retrieval_test_case.py` - Pydantic schemas for retrieval test cases
- `tests/corpus/test_retrieval_expected.py` - Validation tests (17 tests)
- `tests/corpus/fitness/expected/retrieval/` - Directory with 15 JSON test cases:
  - `date-range-jan-2019.json`
  - `date-range-feb-2019.json`
  - `date-range-first-week-march-2019.json`
  - `date-range-sep-2019.json`
  - `date-range-early-feb-2019.json`
  - `keyword-deadlift.json`
  - `keyword-push-press.json`
  - `keyword-bench-press.json`
  - `keyword-squat.json`
  - `keyword-overhead-press.json`
  - `pattern-heavy-deadlift.json`
  - `pattern-high-volume.json`
  - `pattern-shoulder-issues.json`
  - `pattern-korean-entries.json`
  - `pattern-warmup-sets.json`

**Modified files:**
- `tests/corpus/schemas/__init__.py` - Added exports for RetrievalStrategy, RetrievalTestCase

