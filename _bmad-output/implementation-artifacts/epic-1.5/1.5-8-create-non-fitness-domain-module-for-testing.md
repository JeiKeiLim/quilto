# Story 1.5-8: Create Non-Fitness Domain Module for Testing

Status: done

## Story

As a **Quilto developer**,
I want **a simple non-fitness DomainModule for testing**,
So that **domain-agnostic framework behavior can be validated with real code**.

## Acceptance Criteria

1. **JournalDomain module created** - `JournalDomain` module created in `tests/domains/` (NOT in `packages/`)

2. **Module uses existing schema** - Module uses `JournalEntry` schema from `tests/corpus/schemas/journal_schema.py`

3. **All DomainModule fields defined** - Module defines: description, log_schema, vocabulary, expertise

4. **Module is usable by accuracy runner** - Can be used for multi-domain parsing tests

5. **Module demonstrates domain-agnostic** - Proves DomainModule works for non-fitness use cases

6. **Tests verify instantiation** - Tests verify JournalDomain instantiates correctly and validates entries

7. **Tests verify entry validation** - Tests verify JournalEntry schema validates expected outputs correctly

## Tasks / Subtasks

- [x] Task 1: Create tests/domains/ directory structure (AC: #1)
  - [x] 1.1 Create `tests/domains/` directory
  - [x] 1.2 Create `tests/domains/__init__.py` with `JournalDomain` and `journal_domain` exports
  - [x] 1.3 Create `tests/domains/py.typed` marker file (empty file)

- [x] Task 2: Create JournalDomain module (AC: #1, #2, #3, #4, #5)
  - [x] 2.1 Create `tests/domains/journal.py`
  - [x] 2.2 Import `DomainModule` from `quilto`
  - [x] 2.3 Import `JournalEntry` from `tests.corpus.schemas`
  - [x] 2.4 Create `JournalDomain` class inheriting from `DomainModule` with Google-style docstring
  - [x] 2.5 Define description: "Personal journal and diary entries..."
  - [x] 2.6 Define vocabulary with Korean terms (see Dev Notes)
  - [x] 2.7 Define expertise for emotional awareness and reflection patterns
  - [x] 2.8 Create singleton instance `journal_domain`

- [x] Task 3: Create validation tests (AC: #6, #7)
  - [x] 3.1 Create `tests/domains/test_journal_domain.py`
  - [x] 3.2 Test `JournalDomain` instantiates without error
  - [x] 3.3 Test all required `DomainModule` fields are populated (name, description, log_schema, vocabulary)
  - [x] 3.4 Test `log_schema` is `JournalEntry` class
  - [x] 3.5 Test `JournalEntry` validates sample expected outputs from `multi_domain/expected/parser/journal/`
  - [x] 3.6 Test vocabulary contains both English and Korean terms

- [x] Task 4: Validate integration (AC: #4)
  - [x] 4.1 Run `uv run ruff check . --fix && uv run pyright`
  - [x] 4.2 Run `uv run pytest tests/domains/ -v`
  - [x] 4.3 Verify full test suite passes: `uv run pytest`

## Dev Notes

### Project Identity

| Package | Type | Location | This Story |
|---------|------|----------|------------|
| **Quilto** | Framework | `packages/quilto/` | DomainModule imported from here |
| **Swealog** | Application | `packages/swealog/` | NOT touched |
| **Test Code** | Infrastructure | `tests/` | JournalDomain lives here |

### Required Imports

```python
from quilto import DomainModule  # packages/quilto/quilto/__init__.py exports this
from tests.corpus.schemas import JournalEntry  # Already exported at tests/corpus/schemas/__init__.py:16
```

### DomainModule Required Fields (from domain.py:52-71)

| Field | Type | Required | Default |
|-------|------|----------|---------|
| `name` | `str` | No | Class name |
| `description` | `str` | **Yes** | - |
| `log_schema` | `type[BaseModel]` | **Yes** | - |
| `vocabulary` | `dict[str, str]` | **Yes** | - |
| `expertise` | `str` | No | `""` |
| `response_evaluation_rules` | `list[str]` | No | `[]` |
| `context_management_guidance` | `str` | No | `""` |

### JournalEntry Schema (from journal_schema.py:9-24)

```python
class JournalEntry(BaseModel):
    model_config = ConfigDict(strict=True)
    mood: str | None = None       # e.g., "good", "anxious", "stressed"
    topics: list[str] = []        # e.g., ["work", "family", "exercise"]
    date: str | None = None       # YYYY-MM-DD or None
    notes: str | None = None      # Summary or additional context
```

### Vocabulary Requirements

Must include Korean terms for mixed-language entries. Based on multi_domain entries:

```python
vocabulary = {
    # Emotional states (English normalization)
    "felt": "feeling",
    "stressed": "stress",
    "anxious": "anxiety",
    "happy": "happiness",
    "sad": "sadness",
    "tired": "fatigue",
    # Korean emotional terms
    "기분": "mood",
    "스트레스": "stress",
    "피곤": "fatigue",
    "행복": "happiness",
    # Activity terms
    "met": "meeting",
    "talked": "conversation",
    "만남": "meeting",
}
```

### Implementation Pattern (Reference: general_fitness.py:77-128)

```python
"""JournalDomain module for testing Quilto's domain-agnostic interface.

This module is TEST INFRASTRUCTURE, not application code. It demonstrates
that DomainModule works for non-fitness domains.
"""

from quilto import DomainModule
from tests.corpus.schemas import JournalEntry


class JournalDomain(DomainModule):
    """Test domain for personal journal entries.

    This domain covers personal journal and diary entries including
    mood tracking, daily reflections, and personal notes. Used to
    validate DomainModule works for non-fitness use cases.
    """


journal_domain = JournalDomain(
    description=(
        "Personal journal and diary entries including mood tracking, "
        "daily reflections, personal notes, and emotional states. "
        "Covers topics like work, family, health, and daily activities."
    ),
    log_schema=JournalEntry,
    vocabulary={
        "felt": "feeling",
        "stressed": "stress",
        "anxious": "anxiety",
        "happy": "happiness",
        "sad": "sadness",
        "tired": "fatigue",
        "기분": "mood",
        "스트레스": "stress",
        "피곤": "fatigue",
        "행복": "happiness",
        "met": "meeting",
        "talked": "conversation",
        "만남": "meeting",
    },
    expertise=(
        "Emotional awareness and mood tracking patterns. Daily reflection "
        "and journaling conventions. Topic extraction from narrative text. "
        "Recognition of emotional states expressed implicitly or explicitly."
    ),
)
```

### Test Pattern (Reference: test_multi_domain_validation.py)

Follow the parametrized test pattern:

```python
"""Tests for JournalDomain module instantiation and validation.

Validates that JournalDomain correctly implements DomainModule interface
and that JournalEntry schema validates against expected outputs.
"""

import json
from pathlib import Path

import pytest
from quilto import DomainModule

from tests.corpus.schemas import JournalEntry
from tests.domains import JournalDomain, journal_domain

JOURNAL_EXPECTED_DIR = Path(__file__).parent.parent / "corpus" / "multi_domain" / "expected" / "parser" / "journal"


class TestJournalDomainInstantiation:
    """Test JournalDomain instantiates correctly."""

    def test_instantiates_without_error(self) -> None:
        """JournalDomain singleton exists and is valid."""
        assert journal_domain is not None
        assert isinstance(journal_domain, DomainModule)

    def test_name_defaults_to_class_name(self) -> None:
        """Name field defaults to 'JournalDomain'."""
        assert journal_domain.name == "JournalDomain"

    def test_description_is_populated(self) -> None:
        """Description field is non-empty."""
        assert journal_domain.description
        assert "journal" in journal_domain.description.lower()

    def test_log_schema_is_journal_entry(self) -> None:
        """log_schema is JournalEntry class."""
        assert journal_domain.log_schema is JournalEntry

    def test_vocabulary_is_populated(self) -> None:
        """Vocabulary contains expected terms."""
        assert journal_domain.vocabulary
        assert isinstance(journal_domain.vocabulary, dict)

    def test_vocabulary_has_korean_terms(self) -> None:
        """Vocabulary includes Korean emotional terms."""
        korean_terms = ["기분", "스트레스", "피곤", "행복"]
        for term in korean_terms:
            assert term in journal_domain.vocabulary, f"Missing Korean term: {term}"

    def test_expertise_is_populated(self) -> None:
        """Expertise field is non-empty."""
        assert journal_domain.expertise
        assert "emotional" in journal_domain.expertise.lower()


class TestJournalEntryValidation:
    """Test JournalEntry validates expected outputs."""

    @pytest.mark.parametrize(
        "json_file",
        sorted(JOURNAL_EXPECTED_DIR.glob("*.json")),
        ids=lambda p: p.stem,
    )
    def test_expected_output_validates(self, json_file: Path) -> None:
        """Each journal expected JSON validates against JournalEntry schema."""
        with open(json_file) as f:
            data = json.load(f)
        entry = JournalEntry.model_validate(data)
        assert entry is not None
```

### File Structure

```
tests/
├── domains/                        # NEW - This story creates this
│   ├── __init__.py                 # Export JournalDomain, journal_domain
│   ├── py.typed                    # Empty type marker file
│   ├── journal.py                  # JournalDomain implementation
│   └── test_journal_domain.py      # Validation tests
│
└── corpus/
    ├── schemas/
    │   ├── __init__.py             # EXISTING - Already exports JournalEntry
    │   └── journal_schema.py       # EXISTING - JournalEntry schema
    └── multi_domain/
        └── expected/parser/journal/ # EXISTING - 12 JSON files for validation
```

### Validation Commands

```bash
# Quick validation (run frequently)
uv run ruff check . --fix && uv run pyright

# Full validation before completion
uv run ruff check . && uv run ruff format . && uv run pyright && uv run pytest
```

### Anti-Patterns to Avoid

- **DO NOT** create a new JournalEntry schema - reuse from `tests/corpus/schemas`
- **DO NOT** put JournalDomain in `packages/` - it's test infrastructure
- **DO NOT** forget Korean vocabulary terms - multi_domain entries use mixed language
- **DO NOT** skip the `py.typed` marker - pyright requires it for typed packages

### References

- `packages/quilto/quilto/domain.py:12-103` - DomainModule interface
- `tests/corpus/schemas/journal_schema.py:9-24` - JournalEntry schema
- `tests/corpus/schemas/__init__.py:16` - JournalEntry export
- `packages/swealog/swealog/domains/general_fitness.py:77-128` - Implementation pattern
- `tests/corpus/schemas/test_multi_domain_validation.py` - Test pattern
- `tests/corpus/multi_domain/expected/parser/journal/` - 12 validation files

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A

### Completion Notes List

- Created `tests/domains/` directory with proper Python package structure
- Implemented `JournalDomain` class inheriting from `DomainModule` with all required fields
- Used existing `JournalEntry` schema from `tests/corpus/schemas` (no duplication)
- Vocabulary includes both English (felt, stressed, anxious, happy, sad, tired, met, talked) and Korean terms (기분, 스트레스, 피곤, 행복, 만남)
- Created comprehensive test suite with 21 tests covering instantiation and schema validation
- All 12 expected journal JSON files validate successfully against schema
- Full test suite passes: 288 passed, 3 skipped
- pyright: 0 errors, ruff: clean after auto-fix

### File List

- `tests/domains/__init__.py` (NEW)
- `tests/domains/py.typed` (NEW)
- `tests/domains/journal.py` (NEW)
- `tests/domains/test_journal_domain.py` (NEW)

---

## Senior Developer Review (AI)

**Reviewer:** Amelia (Dev Agent)
**Date:** 2026-01-09
**Status:** ✅ APPROVED

### Review Summary

| Category | Issues Found | Fixed |
|----------|--------------|-------|
| Critical | 0 | - |
| High | 0 | - |
| Medium | 5 | 5 |
| Low | 2 | 2 |

### Issues Fixed During Review

**M1. Missing `__all__` in journal.py** → Added `__all__ = ["JournalDomain", "journal_domain"]`

**M2. Missing test for optional DomainModule fields** → Added `test_optional_fields_have_defaults()` verifying `response_evaluation_rules` and `context_management_guidance`

**M3. Missing test for direct instantiation** → Added `test_direct_instantiation()` validating `JournalDomain(...)` constructor works

**M4. Missing activity terms test** → Added `test_vocabulary_has_activity_terms()` for "met", "talked", "만남"

**M5. No test for empty directory edge case** → Added `test_expected_dir_has_json_files()` to verify JSON files exist

**L1. Docstring improvement** → Updated `TestJournalDomainInstantiation` docstring to mention "test infrastructure"

**L2. Type annotation** → Added `: Path` annotation to `JOURNAL_EXPECTED_DIR`

### Post-Review Validation

- Tests: 25 passed (up from 21) in `tests/domains/`
- Full suite: 292 passed, 3 skipped
- pyright: 0 errors
- ruff: All checks passed

### AC Verification

| AC | Status | Evidence |
|----|--------|----------|
| #1 JournalDomain created in tests/domains/ | ✅ | `tests/domains/journal.py` |
| #2 Uses existing JournalEntry schema | ✅ | Import from `tests.corpus.schemas` |
| #3 All DomainModule fields defined | ✅ | description, log_schema, vocabulary, expertise |
| #4 Usable by accuracy runner | ✅ | Proper exports, validates against test corpus |
| #5 Demonstrates domain-agnostic | ✅ | Non-fitness domain validates correctly |
| #6 Tests verify instantiation | ✅ | 12 instantiation tests |
| #7 Tests verify entry validation | ✅ | 13 schema validation tests |

### Change Log

| Date | Action | Author |
|------|--------|--------|
| 2026-01-09 | Code review with 7 fixes applied | Amelia (Dev Agent) |
