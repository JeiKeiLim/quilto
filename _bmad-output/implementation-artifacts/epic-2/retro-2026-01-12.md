# Epic 2 Retrospective - Input & Storage

**Date:** 2026-01-12
**Facilitator:** Bob (Scrum Master)
**Epic Status:** Complete (5/5 stories done)

---

## Team Participants

- Alice (Product Owner)
- Bob (Scrum Master) - Facilitator
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Jongkuk Lim (Project Lead)

---

## Epic Summary

**Epic 2: Input & Storage**

| Metric | Value |
|--------|-------|
| Stories Completed | 5/5 (100%) |
| Tests Written | ~204 new tests |
| New Agents | 2 (Router, Parser) |
| New Domain Modules | 2 (Strength, Nutrition) |
| Korean Vocabulary Terms | 90+ total |
| Code Review Cycles | 5 |
| Production Incidents | 0 |

### Stories Delivered

| Story | Deliverable | Tests | Review Issues Fixed |
|-------|-------------|-------|---------------------|
| 2-1 | StorageRepository (6 methods) | 40 | 6 |
| 2-2 | Router Agent (LOG classification) | 36 | 5 |
| 2-3 | Parser Agent (structured extraction) | 36 | 10+ |
| 2-4 | Strength Domain | 44 | 3 |
| 2-5 | Nutrition Domain | 48 | 0 |

### FRs Covered

- FR-F1: Accept unstructured text input
- FR-F2: Store raw notes
- FR-F3: Parse and extract structured data
- FR-F7: Classify input (Router - LOG path)
- FR-F14: Extract structured data (Parser)
- FR-F20: StorageRepository abstraction
- FR-A2: Strength subdomain
- FR-A4: Nutrition subdomain
- FR-A6: Domain-specific log schemas
- FR-A7: Domain vocabularies

---

## Epic 1.5 Retrospective Action Item Follow-Through

| # | Action Item | Status | Notes |
|---|-------------|--------|-------|
| 1 | Scope ruff/format commands | ⏳ In Progress | No issues this epic |
| 2 | Update sprint-status.yaml | ✅ Completed | Epic 1.5 marked done |
| 3 | Monitor expected output accuracy | ⏳ In Progress | Parser testing ongoing |

---

## What Went Well

### Successes

1. **`make test-ollama` requirement** - Catching real LLM integration issues early
2. **Pattern maturity by end of epic** - Story 2-5 (Nutrition) had zero code review issues
3. **Comprehensive Korean vocabulary** - 60+ terms in Strength, 30+ in Nutrition from authoritative sources
4. **Strict Pydantic validation everywhere** - `ConfigDict(strict=True)` consistently applied
5. **Test coverage excellence** - 204 new tests with boundary value coverage

### Breakthrough Moments

- **Story 2-2:** Created reusable test infrastructure (`conftest.py` with `--use-real-ollama` hook)
- **Story 2-4:** RPE/RIR mutual exclusivity pattern using `@model_validator(mode="after")`
- **Story 2-5:** Cleanest story - zero code review issues (pattern maturity)

### Patterns That Worked

| Pattern | First Used | Impact |
|---------|------------|--------|
| `make test-ollama` before completion | 2-1 | Caught integration issues |
| `Field(min_length=1)` for required strings | 2-4 | Prevents empty string bugs |
| Public `build_prompt()` for testability | 2-2 | Easier prompt testing |
| Korean vocab from authoritative source | 2-4 | Accurate normalization |

---

## Challenges Identified

### Recurring Code Review Issues

| Issue | Stories Affected | Root Cause |
|-------|------------------|------------|
| Empty string validation missing | 2-2, 2-4 | Not in mental checklist |
| Boundary value tests missing | 2-1, 2-2 | Easy to forget edge cases |
| `py.typed` marker missing | 2-2 | One-time setup, easy to miss |
| Story status not updated after review | 2-3 | Manual process |

### Key Challenge: No Manual Validation

**Problem:** All Epic 2 components (Router, Parser, Storage, Domains) can only be tested via pytest. No way to manually try the system.

**Impact:** Cannot "feel" how the system behaves. Usability issues may go unnoticed.

**Resolution:** Create manual validation script (Action Item #1)

---

## Key Learnings

1. **Integration tests with real LLM are essential** - `make test-ollama` catches what mocks cannot
2. **Pattern maturity takes time** - Early stories have more issues, later stories are cleaner
3. **Same mistakes recur without prevention** - Need checklists and documented patterns
4. **Manual validation is necessary** - Automated tests prove correctness, manual tests prove usability
5. **Keep CLAUDE.md minimal** - Put detailed rules in `project-context.md` instead

---

## Preparation for Epic 3

### Epic 3: Query & Retrieval

| Story | Description | Depends On |
|-------|-------------|------------|
| 3-1 | Extend Router for QUERY/BOTH | Router (2-2) |
| 3-2 | Implement Planner agent | Router patterns |
| 3-3 | Implement Retriever agent | StorageRepository (2-1) |
| 3-4 | Create Running domain module | Domain patterns (2-4, 2-5) |

### Dependencies Verified

- ✅ Router agent ready for extension
- ✅ StorageRepository ready for Retriever
- ✅ Domain module patterns established

### Preparation Needed

- Manual validation script must complete before Epic 3
- Team needs to study state machine architecture (13 states, 34 transitions)
- LangGraph patterns for orchestration

### Technical Risks

- State machine complexity (34 transitions)
- Cycle termination conditions
- Query decomposition logic in Planner

---

## Action Items

| # | Action Item | Owner | Priority | Rationale |
|---|-------------|-------|----------|-----------|
| 1 | Create manual validation script (`scripts/manual_test.py`) | Charlie (Dev) | **HIGH** | Validate Epic 2 before building on it |
| 2 | Add "Common Mistakes" section to `project-context.md` | Bob (SM) | **HIGH** | Prevent recurring issues |
| 3 | Add pre-review checklist to story template | Bob (SM) | **MEDIUM** | Catch issues before review |
| 4 | Fix Story 2-3 status (file says "review") | Bob (SM) | **LOW** | Status consistency |

### Common Mistakes to Document

| Mistake | Correct Pattern | Learned From |
|---------|-----------------|--------------|
| Required string without length check | `Field(min_length=1)` | Story 2-4 |
| Redundant `@field_validator` for range | `Field(ge=0, le=10)` | Story 2-4 |
| Missing boundary value tests | Test 0.0, 1.0, exact limits | Story 2-1, 2-2 |
| Missing `py.typed` in new package | Add marker file | Story 2-2 |
| Empty string not tested separately | Test both `None` and `""` | Story 2-2 |

---

## Epic 3 Preparation Tasks

| # | Task | Owner | Priority |
|---|------|-------|----------|
| 1 | Run manual validation script to verify Epic 2 | Team | **HIGH** |
| 2 | Study state machine architecture | Elena + Team | **MEDIUM** |
| 3 | Review LangGraph patterns | Charlie | **MEDIUM** |

---

## Technical Debt

| Item | Severity | Notes |
|------|----------|-------|
| Story 2-3 status mismatch | LOW | File says "review", sprint-status says "done" |
| Parser strength notation | MEDIUM | Parser doesn't understand common notation patterns. Needs prompt improvement. |

### Parser Notation Issues (from manual testing)

**Patterns not recognized:**
- `REPSxSETS`: "10x5" → should be 10 reps × 5 sets
- `WEIGHTxREPSxSETS`: "80x5x5" → should be 80 weight × 5 reps × 5 sets
- `WEIGHTxREPS`: "185x5" → 185 weight × 5 reps (this one works)

**Test cases that failed:**
1. "Bench 80x5x5 today" → Created 2 sets instead of 5, total_sets=10 (wrong)
2. "중량 푸쉬업 20kg 10x5" → Created 1 set, put "10x5" in notes instead of parsing

**Fix:** Add notation pattern examples to Parser system prompt in `parser.py`

---

## Retrospective Outcome

| Item | Status |
|------|--------|
| Epic 2 Review | Complete |
| Previous Retro Follow-Through | 2/3 in progress, 1/3 done |
| Action Items | 4 captured |
| Preparation Tasks | 3 captured |
| Process Improvements | 2 (pre-review checklist, common mistakes doc) |
| Next Epic Ready | After manual validation script |

---

## Closing Notes

**Jongkuk Lim (Project Lead):** "Quality is our priority. The `make test-ollama` change at end of dev helped catch integration issues. Manual validation script is needed to actually feel the system."

**Team Consensus:** Epic 2 delivered solid foundation. Manual validation script is critical before Epic 3. Pattern maturity showed improvement across stories.

---

*Retrospective facilitated by Bob (Scrum Master)*
*Document generated: 2026-01-12*
